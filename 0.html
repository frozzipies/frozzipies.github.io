<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto Geolocation Prompt (Demo)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 2rem; }
    .status { margin-top: 1rem; padding: 0.75rem; border-radius: 8px; background:#f3f4f6; }
    .error { color: #b91c1c; }
    .hint { color: #374151; font-size: 0.9rem; margin-top: 0.75rem; }
  </style>
</head>
<body>
  <h1>Auto Geolocation Prompt (Demo)</h1>
  <p>This page will request the browser's Geolocation permission when the page loads.</p>

  <div id="out" class="status">Waiting…</div>
  <div id="hint" class="hint"></div>

  <script>
    const out = document.getElementById('out');
    const hint = document.getElementById('hint');

    function log(msg, cls) {
      out.textContent = msg;
      out.className = 'status' + (cls ? ' ' + cls : '');
    }

    async function requestOnLoad() {
      // Feature detect
      if (!('geolocation' in navigator)) {
        log('Geolocation API not available in this browser.', 'error');
        return;
      }

      // Check Permissions API if available (read-only). This doesn't request permission,
      // but lets us decide whether to call getCurrentPosition (which will trigger the prompt).
      if (navigator.permissions && navigator.permissions.query) {
        try {
          const p = await navigator.permissions.query({ name: 'geolocation' });
          // states: 'granted', 'denied', 'prompt'
          if (p.state === 'granted') {
            log('Permission already granted — retrieving location...');
            getLocation();
            return;
          }
          if (p.state === 'denied') {
            log('Permission previously denied. The browser will not show a prompt.');
            hint.textContent = 'You can change this in your browser/site settings to allow location.';
            return;
          }
          // p.state === 'prompt' -> proceed to request (this normally triggers a prompt)
        } catch (e) {
          // Permissions API might throw on some browsers; we'll still try to request.
          console.warn('Permissions API check failed:', e);
        }
      }

      // Attempt to trigger the browser prompt by calling getCurrentPosition.
      // This is the standard API and is the legitimate way to request permission.
      log('Requesting location permission (this may trigger a browser prompt)...');
      getLocation();
    }

    function getLocation() {
      navigator.geolocation.getCurrentPosition(
        pos => {
          log('Location obtained: Lat ' + pos.coords.latitude.toFixed(6) +
              ', Lon ' + pos.coords.longitude.toFixed(6));
          hint.textContent = 'Permission granted. This demo only reads coordinates and does not send them anywhere.';
        },
        err => {
          switch (err.code) {
            case err.PERMISSION_DENIED:
              log('User denied the request for Geolocation.', 'error');
              hint.textContent = 'If you want to allow it, change the site permission in your browser settings.';
              break;
            case err.POSITION_UNAVAILABLE:
              log('Location information is unavailable.', 'error');
              break;
            case err.TIMEOUT:
              log('The request to get user location timed out.', 'error');
              break;
            default:
              log('An unknown error occurred: ' + err.message, 'error');
          }
        },
        { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 }
      );
    }

    // Trigger automatically after DOM is ready
    window.addEventListener('DOMContentLoaded', () => {
      // small delay sometimes helps on some browsers — optional
      setTimeout(requestOnLoad, 200);
    });
  </script>
</body>
</html>
